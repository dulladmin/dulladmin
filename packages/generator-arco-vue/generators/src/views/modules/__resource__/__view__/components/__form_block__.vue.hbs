<!-- Code generated by DullAdmin; DO NOT EDIT. -->

<template>
  <div>
    <a-card :title="$t('{{title.i18nKey}}')" class="dulladmin-form-block">
      <a-spin style="display: block" :loading="loading">
        <a-form :model="store" :auto-label-width="true">
        {{#each model.attributes}}
          <DullFormItem
            v-model="store.{{name}}"
            :meta="modelMetadata.{{name}}"
          />
        {{/each}}
        {{#unless model.attributes}}
          <a-form-item>
            <a-alert {{#if formOptions.isDanger}}type="warning"{{/if}}>
              \{{ $t('form.actions.{{formOptions.actionName}}.alert.message') }}
            </a-alert>
          </a-form-item>
        {{/unless}}
          <a-form-item>
            <a-space>
              <a-button
                type="primary"
              {{#if formOptions.isDanger}}
                status="danger"
              {{/if}}
                :loading="saving"
                @click="onFormSave"
              >
                <template #icon>
                  <icon-save />
                </template>
                \{{ $t('form.actions.{{formOptions.actionName}}') }}
              </a-button>
            </a-space>
          </a-form-item>
        </a-form>
      </a-spin>
    </a-card>
  </div>
</template>

<script lang="ts" setup>
  import { computed, reactive, ref } from 'vue';
  import { useRouter, useRoute } from 'vue-router';
  import { useI18n } from 'vue-i18n';
  import { omitBy } from 'lodash';
  import { Message } from '@arco-design/web-vue';
  import { FormModel, UpdateRequest, get, update } from '{{ apiImportPath }}';
  import { useLoading, useTabbableViewBlock } from '@/hooks';
  import { useAppStore } from '@/store';

  // i18n
  const { t } = useI18n();

  // route
  const router = useRouter();
  const route = useRoute();
  const id = (route.params.id as string) ?? '';

  // model
  const modelMetadata: { [key: string]: any } = {
  {{#each model.attributes}}
    {{#if object.attributes}}
    {{name}}: {
      type: '{{type}}',
      hidden: {{hidden}},
      {{#each object.attributes}}
      {{name}}: {
        type: '{{type}}',
        i18nKey: '{{i18nKey}}',
      },
      {{/each}}
    },
    {{else}}
    {{name}}: {
      type: '{{type}}',
      hidden: {{hidden}},
      i18nKey: '{{i18nKey}}',
      {{#if optionals}}
      optionals: {
        {{#each optionals}}
        {{name}}: {
          i18nKey: '{{i18nKey}}',
        },
        {{/each}}
      },
      {{/if}}
    },
    {{/if}}
  {{/each}}
  };

  // form - store
  const { loading, setLoading } = useLoading(true);
  const store = ref<FormModel>({
  {{#each model.attributes}}
    {{#if collection}}
    {{name}}: [],
    {{else}}
    {{name}}: undefined,
    {{/if}}
  {{/each}}
  });
  const fetchStore = async () => {
    setLoading(true);
    try {
      {{#if formOptions.noGet}}
      const _ = null;
      {{else}}
      const { data } = await get(id);
      const { form } = data;

      if (form) {
        store.value = form;
      }
      {{/if}}
    } finally {
      setLoading(false);
    }
  };

  // form - save
  const appStore = useAppStore();
  const { loading: saving, setLoading: setSaving } = useLoading(false);
  const onFormSave = async () => {
    setSaving(true);
    try {
      const req = {
        form: omitBy(store.value, (v) => {
          return v == null
        }),
      } as UpdateRequest;
      const { data } = await update(id, req);
      const { form } = data;

      if (form) {
        store.value = form;
      }

      Message.success(t('form.actions.{{formOptions.actionName}}.success'));

      {{#if formOptions.allowBackOnSave }}
      const { back } = route.query;
      if (back) {
        appStore.removeCurrentActiveTab();
        appStore.setNewTabOpenParams({ refresh: true });
        router.replace({ path: back as string });
      }
      {{/if}}
    } finally {
      setSaving(false);
    }
  };

  // form - refresh
  const onFormRefresh = async () => {
    await fetchStore();
  };

  // form - tabbable
  useTabbableViewBlock({
    viewName: '{{view.name}}',
    refreshFn: onFormRefresh,
  });

  // form - init
  onFormRefresh();
</script>
