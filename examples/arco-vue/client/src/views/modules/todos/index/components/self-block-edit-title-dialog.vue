<!-- Code generated by DullAdmin; DO NOT EDIT. -->

<template>
  <a-modal
    v-model:visible="visible"
    class="da-form-dialog dac-self-block-edit-title-dialog"
    :ok-text="$t('form.actions.save')"
    :ok-button-props="{disabled: loading}"
    :on-before-ok="handleModalBeforeOk"
    @cancel="handleModalCancel"
    @close="handleModalClose"
  >
    <template #title>
      {{ $t('todos--index.self-block.title') }}
      -
      {{ $t('todos--index.self-block.edit-title-dialog.title') }}
    </template>
    <div>
      <a-spin style="display: block" :loading="loading">
        <a-form :model="store" :auto-label-width="true">
          <DullFormItem
            v-model="store.title"
            :meta="modelMetadata.title"
          />
        </a-form>
      </a-spin>
    </div>
  </a-modal>
</template>

<script lang="ts" setup>
  import { computed, ref, watch } from 'vue';
  import { useRouter, useRoute } from 'vue-router';
  import { useI18n } from 'vue-i18n';
  import { omitBy } from 'lodash';
  import { Message } from '@arco-design/web-vue';
  import { FormModel, UpdateRequest, get, update } from '@/api/modules/todos/index/self-block-edit-title-dialog';
  import { useLoading } from '@/hooks';

  // props
  const props = defineProps<{
    visible: boolean;
    id: string;
    okCallback: (options: Record<string, any>) => void;
  }>();
  const emits = defineEmits<{
    (e: 'update:visible', newValue: boolean): void;
  }>();

  // i18n
  const { t } = useI18n();

  // route
  const router = useRouter();
  const route = useRoute();
  const id = (route.params.id as string) ?? '';

  // model
  const modelMetadata: { [key: string]: any } = {
    title: {
      type: 'string',
      hidden: false,
      i18nKey: 'todos--index.self-block.edit-title-dialog.model.attributes.title',
    },
  };

  // form - model
  const baseModel: FormModel = {
    title: undefined,
  };

  // form - store
  const { loading, setLoading } = useLoading(true);
  const store = ref<FormModel>({
    ...baseModel
  });
  const fetchStore = async () => {
    setLoading(true);
    try {
      const { data } = await get(id, props.id);
      const { form } = data;

      if (form) {
        store.value = form;
      }
    } finally {
      setLoading(false);
    }
  };

  // form - save
  const { loading: saving, setLoading: setSaving } = useLoading(false);
  const onFormSave = async () => {
    setSaving(true);
    try {
      const req = {
        form: omitBy(store.value, (v) => {
          return v == null
        }),
      } as UpdateRequest;
      const { data } = await update(id, props.id, req);
      const { form } = data;

      if (form) {
        store.value = form;
      }

      Message.success(t('form.actions.save.success'));

      const { model } = data;
      props.okCallback({ model });
    } finally {
      setSaving(false);
    }
  };

  // form - refresh
  const onFormRefresh = async () => {
    await fetchStore();
  };

  // modal - visible
  const visible = ref(false);
  watch(
    () => props.visible,
    (val) => {
      if (val) {
        visible.value = true;
        onFormRefresh();
      }
    }
  );

  // modal - ok
  const handleModalBeforeOk = async () => {
    await onFormSave();
    visible.value = false;
    emits('update:visible', false);
  };

  // modal - cancel
  const handleModalCancel = () => {
    visible.value = false;
    emits('update:visible', false);
  };

  // modal - close
  const handleModalClose = () => {
    store.value = {
      ...baseModel
    };
  };
</script>
